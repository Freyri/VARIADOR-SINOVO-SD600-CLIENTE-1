<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CONTROL VARIADOR SINO SD600</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background: transparent;
  color: #000000;
  text-align: center;
  padding-top: 60px;
}
h1 { font-size: 2em; margin: 0; }

#texto {
  font-size: 1.2em;
  margin-top: 20px;
  white-space: pre-line;
}

button {
  background: #0f0; color: #111; font-size: 1.05em;
  padding: 10px 22px; border: 2px solid #000; border-radius: 10px;
  cursor: pointer; margin: 10px; transition: 0.15s;
}
button:hover { background: #5f5; }

#panelManual, #panelFrecuencia, #panelStatus {
  margin-top: 40px;
}
#panelManual h2, #panelFrecuencia h2, #panelStatus h2 {
  color: #CC0000;
  margin-bottom: 10px;
}

#panelFrecuencia .slider-section { margin-bottom: 20px; }
#panelFrecuencia .manual-section {
  display: flex; justify-content: center; align-items: baseline; gap: 10px;
}
#panelFrecuencia input[type="number"] {
  font-size: 1.1em;
  border-radius: 10px;
  text-align: center;
  width: 110px;
  height: 38px;
  padding: 0 6px;
}

#fullscreenBtn {
  position: fixed; top: 10px; right: 10px;
  background: rgba(255, 255, 255, 0.15); color: #e5e7eb;
  border: none; border-radius: 10px; font-size: 22px; padding: 8px 10px;
  cursor: pointer; transition: all 0.3s ease; z-index: 9999;
}
#fullscreenBtn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
/* --- Borde verde para FRECUENCIA MANUAL --- */
#inputFreq {
  border: 2px solid #000 !important;
}
/* Quitar flechas del numeric */
#inputFreq::-webkit-inner-spin-button,
#inputFreq::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
#inputFreq {
  -moz-appearance: textfield;
}
.input-wrapper {
  position: relative;
  display: inline-block;
}

#inputFreq {
  padding-right: 32px; /* espacio para "Hz" */
}

.hz-label {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-weight: normal;
  color: #000;
  pointer-events: none; /* para que no bloquee el click */
}

</style>
</head>
<body>

<button id="fullscreenBtn" title="Pantalla completa">üñ•Ô∏è</button>

<h1>CONTROL DE VARIADOR SINOVO SD600</h1>

<div id="panelStatus">
  <h2>üìä Estado en Vivo</h2>
  <pre id="texto">üåê Conectando a MQTT...</pre>
</div>

<div id="panelManual">
  <h2>‚öôÔ∏è Control Manual</h2>
  <button id="btnStart">üü¢ START</button>
  <button id="btnStop">üî¥ STOP</button>
</div>

<div id="panelFrecuencia">
  <h2>üéöÔ∏è Control de Frecuencia</h2>
  
  <div class="slider-section">
    <label for="sliderFreq">Frecuencia (Hz):</label><br>
    <input type="range" id="sliderFreq" min="0" max="60" step="0.1" value="0" style="width:70%; margin-top:10px;">
    <p id="valorSlider">üî∏ 0.00 Hz</p>
  </div>

  <div class="manual-section">
    <div class="input-wrapper">
      <input type="number" id="inputFreq" min="0" max="60" step="0.01" value="0">
      <span class="hz-label">Hz</span>
    </div>
</div>

</div>

<script>
// --- Configuraci√≥n MQTT ---
const topicControl = "control/variador/sinovosd600/cliente1/cmd";
const topicStatus  = "control/variador/sinovosd600/cliente1/status";
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

const texto = document.getElementById('texto');

// --- SINCRONIZACI√ìN SOLO UNA VEZ ---
let sincronizado = false; // <-- bandera para sincronizaci√≥n HMI
const slider = document.getElementById('sliderFreq');
const valorSlider = document.getElementById('valorSlider');
const inputFreq = document.getElementById('inputFreq');
let enviarTimeout = null;

const TELEGRAM_WORKER = "https://botdealarmasc1.freyricity123k.workers.dev/"; // <- tu URL de Worker
let lastSentStatus = ""; // para evitar duplicar mensajes
let inicializado = false; // <-- ignorar primer mensaje MQTT

// =======================================================
// üü¢ MQTT CONNECT
// =======================================================
client.on("connect", () => {
  console.log("‚úÖ Conectado a broker MQTT");
  texto.innerText = "üåê Conectado a MQTT";

  client.subscribe(topicStatus, (err) => {
    if(!err) console.log("üì° Suscrito al topic de estado");
  });
});

client.on("error", (err) => {
  console.error("‚ö†Ô∏è Error MQTT:", err);
  texto.innerText = "‚ùå Error MQTT";
});

// =======================================================
// üü¢ RECIBIR MENSAJES DE ESTADO
// =======================================================
client.on("message", (topic, message) => {
  try {
    // --- ignorar primer mensaje al abrir la p√°gina ---
    if(!inicializado){
      inicializado = true;
      return;
    }

    const data = JSON.parse(message.toString());

    const freq = (data.H100 / 100).toFixed(2);
    const volt = data.H101.toFixed(0);
    const amp  = (data.H102 / 100).toFixed(2);
    const pot  = (data.H103 / 10).toFixed(2);
    const hmi_freq = (data.H105 / 100).toFixed(2);
    const status = data.Status || "DESCONOCIDO";

    // üîπ Solo sincroniza **una vez** con el HMI
    if (!sincronizado) {
      sincronizado = true;
      slider.value = hmi_freq;
      inputFreq.value = hmi_freq;
      valorSlider.innerText = `üî∏ ${hmi_freq} Hz`;
      console.log("üîÑ Sincronizado con HMI:", hmi_freq, "Hz");
    }

    // Actualizar estado de la m√°quina
    let statusEmoji = "‚ùî";
    switch(status) {
      case "ENCENDIDO": statusEmoji = "üü¢"; break;
      case "APAGADO": statusEmoji = "üî¥"; break;
      case "ALARMADO": statusEmoji = "‚ö†Ô∏è"; break;
    }

    // --- Enviar autom√°ticamente al Telegram Worker ---
    let msgTelegram = "";
    switch(status){
      case "ENCENDIDO": msgTelegram = "üöÄ MOTOR ENCENDIDO"; break;
      case "APAGADO":  msgTelegram = "üõë MOTOR APAGADO"; break;
      case "ALARMADO": msgTelegram = "‚ö†Ô∏è MOTOR ALARMADO"; break;
    }

    // Solo enviar si cambi√≥ el estado desde la √∫ltima vez
    if(msgTelegram && msgTelegram !== lastSentStatus){
      fetch(TELEGRAM_WORKER + "/?msg=" + encodeURIComponent(msgTelegram));
      lastSentStatus = msgTelegram; // actualizar estado
    }

    texto.innerText = 
      `‚ö° Motor: ${statusEmoji} ${status}\n` +
      `üéöÔ∏è Frecuencia: ${freq} Hz\n` +
      `üîå Voltaje: ${volt} V\n` +
      `üîã Corriente: ${amp} A\n` +
      `üí° Potencia: ${pot} kW`;
  } catch(e) {
    console.error("Error parseando JSON:", e);
  }
});

// =======================================================
// üü¢ START / STOP
// =======================================================
document.getElementById('btnStart').onclick = () => {
  if(client.connected) client.publish(topicControl, "prende motor");
};
document.getElementById('btnStop').onclick = () => {
  if(client.connected) client.publish(topicControl, "apaga motor");
};

// =======================================================
// üü¢ Cambio del slider
// =======================================================
slider.oninput = () => {
  const valor = parseFloat(slider.value).toFixed(2);
  valorSlider.innerText = `üî∏ ${valor} Hz`;
  inputFreq.value = valor;  
  clearTimeout(enviarTimeout);
  enviarTimeout = setTimeout(() => {
    if(client.connected) client.publish(topicControl, valor);
  }, 300);
};

// =======================================================
// üü¢ Validaci√≥n al perder el foco (inputFreq)
// =======================================================
inputFreq.addEventListener("blur", () => {
  let valor = parseFloat(inputFreq.value);

  if (isNaN(valor)) valor = 0;

  // Limitar entre 0 y 60
  valor = Math.min(60, Math.max(0, valor));

  // Formato fijo 2 decimales
  inputFreq.value = valor.toFixed(2);

  // Sincronizar slider
  slider.value = valor;
  valorSlider.innerText = `üî∏ ${valor.toFixed(2)} Hz`;

  // Enviar por MQTT
  if (client.connected) client.publish(topicControl, valor.toFixed(2));
});

// =======================================================
// üü¢ Pantalla completa
// =======================================================
const fullscreenBtn = document.getElementById("fullscreenBtn");
fullscreenBtn.addEventListener("click", async () => {
  if(!document.fullscreenElement) {
    await document.documentElement.requestFullscreen().catch(console.warn);
  } else {
    await document.exitFullscreen();
  }
});
</script>


</body>
</html>
